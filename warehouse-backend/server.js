require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const multer = require("multer");
const path = require("path");

const app = express();
app.use(express.json());
app.use(cors());


const PORT = process.env.PORT || 5000;
const MONGO_URI = process.env.MONGO_URI;

// K·∫øt n·ªëi MongoDB
mongoose.connect(MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => console.log("‚úÖ MongoDB connected"))
  .catch(err => {
    console.error("‚ùå DB Connection Error:", err);
    process.exit(1);
  });

  // C·∫•u h√¨nh Multer (Upload ·∫£nh)
const storage = multer.diskStorage({
  destination: "./uploads/",
  filename: (req, file, cb) => {
    cb(null, Date.now() + path.extname(file.originalname));
  },
});
const upload = multer({ storage });

// Cho ph√©p truy c·∫≠p th∆∞ m·ª•c ch·ª©a ·∫£nh
app.use("/uploads", express.static("uploads"));

// API Upload ·∫£nh
app.post("/upload", upload.single("image"), (req, res) => {
  if (!req.file) return res.status(400).json({ error: "Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n" });
  res.json({ imageUrl: `http://localhost:${PORT}/uploads/${req.file.filename}` });
});

// Model s·∫£n ph·∫©m
const Product = mongoose.model("Product", new mongoose.Schema({
  code: String,
  name: String,
  description: String,
  quantity: Number,
  price: Number,
  supplier: String,
  minThreshold: Number,
  image: String,
  createdAt: { type: Date, default: Date.now },
}));

// üìå Schema cho doanh s·ªë b√°n h√†ng
const salesSchema = new mongoose.Schema({
  date: String,
  seller: String,
  amount: Number,
});
const Sale = mongoose.model("Sale", salesSchema);

// Model ƒë∆°n h√†ng (Order)
const Order = mongoose.model("Order", new mongoose.Schema({
  totalPrice: { type: Number, required: true },
  createdAt: { type: Date, default: Date.now },
}));

// Model nh·∫≠p h√†ng (Import)
const Import = mongoose.model("Import", new mongoose.Schema({
  totalCost: { type: Number, required: true },
  importDate: { type: Date, default: Date.now },
}));

 
// Model giao d·ªãch nh·∫≠p/xu·∫•t kho
const Transaction = mongoose.model("Transaction", new mongoose.Schema({
  productId: { type: mongoose.Schema.Types.ObjectId, ref: "Product", required: true },
  type: { type: String, enum: ["import", "export"], required: true },
  quantity: { type: Number, required: true },
  date: { type: Date, default: Date.now },
}));

// üìå Schema cho qu·∫£n l√Ω kho h√†ng (Inventory)
const inventorySchema = new mongoose.Schema({
  productId: { type: mongoose.Schema.Types.ObjectId, ref: "Product", required: true },
  quantity: { type: Number, default: 0 },
  lastUpdated: { type: Date, default: Date.now }
});
const Inventory = mongoose.model("Inventory", inventorySchema);

// --------------------- C√°c API hi·ªán c√≥ -----------------------

// üìå API: L·∫•y danh s√°ch s·∫£n ph·∫©m
app.get("/products", async (req, res) => {
  try {
    const products = await Product.find();
    res.json(products);
  } catch (err) {
    console.error("Error fetching products:", err);
    res.status(500).json({ error: "L·ªói khi l·∫•y danh s√°ch s·∫£n ph·∫©m" });
  }
});

// API th√™m s·∫£n ph·∫©m
app.post("/products", upload.single("image"), async (req, res) => {
  try {
    const { code, name, description, quantity, price, supplier, minThreshold } = req.body;
    const image = req.file ? `/uploads/${req.file.filename}` : null;

    const newProduct = new Product({
      code, name, description, quantity, price, supplier, minThreshold, image
    });

    await newProduct.save();
    res.status(201).json(newProduct);
  } catch (error) {
    res.status(400).json({ error: "L·ªói khi th√™m s·∫£n ph·∫©m", details: error.message });
  }
});

// API t√¨m ki·∫øm s·∫£n ph·∫©m
app.get("/products/search", async (req, res) => {
  try {
    const { name } = req.query;
    if (!name) {
      return res.status(400).json({ error: "Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm" });
    }
    const results = await Product.find({ name: new RegExp(name, "i") });
    res.json(results);
  } catch (error) {
    res.status(500).json({ error: "L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m" });
  }
});


// üìå API: Th√™m s·∫£n ph·∫©m m·ªõi
app.post("/products", async (req, res) => {
  const newProduct = new Product(req.body);
  await newProduct.save();
  res.json(newProduct);
});

// üìå API: C·∫≠p nh·∫≠t s·∫£n ph·∫©m
app.put("/products/:id", async (req, res) => {
  const updatedProduct = await Product.findByIdAndUpdate(req.params.id, req.body, { new: true });
  res.json(updatedProduct);
});

// üìå API: X√≥a s·∫£n ph·∫©m
app.delete("/products/:id", async (req, res) => {
  await Product.findByIdAndDelete(req.params.id);
  res.json({ message: "S·∫£n ph·∫©m ƒë√£ b·ªã x√≥a" });
});

// üìå API: L·∫•y danh s√°ch doanh s·ªë b√°n h√†ng
app.get("/sales", async (req, res) => {
  const sales = await Sale.find();
  res.json(sales);
});

// üìå API: Th√™m d·ªØ li·ªáu doanh s·ªë b√°n h√†ng
app.post("/sales", async (req, res) => {
  const newSale = new Sale(req.body);
  await newSale.save();
  res.json(newSale);
});

// üìå API: X√≥a doanh s·ªë b√°n h√†ng
app.delete("/sales/:id", async (req, res) => {
  await Sale.findByIdAndDelete(req.params.id);
  res.json({ message: "Giao d·ªãch b√°n h√†ng ƒë√£ b·ªã x√≥a" });
});

// API: L·∫•y d·ªØ li·ªáu t·ªìn kho t·ª´ collection Product
app.get("/api/stock-report", async (req, res) => {
  try {
    const stockReport = await Product.find({}, "code name quantity price minThreshold");
    console.log("D·ªØ li·ªáu t·ªìn kho t·ª´ backend:", stockReport); // Log d·ªØ li·ªáu tr·∫£ v·ªÅ
    res.json(stockReport);
  } catch (error) {
    console.error("Error fetching stock report:", error);
    res.status(500).json({ error: "L·ªói khi l·∫•y d·ªØ li·ªáu t·ªìn kho" });
  }
});


// üìå API: L·∫•y d·ªØ li·ªáu nh·∫≠p xu·∫•t kho
app.get("/api/import-export-report", async (req, res) => {
  try {
    const report = await Transaction.find().populate("productId", "code name");
    console.log("Import-Export Report:", report); // Log d·ªØ li·ªáu giao d·ªãch
    res.json(report);
  } catch (error) {
    console.error("Error fetching import-export report:", error);
    res.status(500).json({ error: "L·ªói khi l·∫•y d·ªØ li·ªáu nh·∫≠p xu·∫•t" });
  }
});

// üìå API: L·∫•y d·ªØ li·ªáu doanh thu
app.get("/api/revenue-report", async (req, res) => {
  try {
    console.log("üìä B·∫Øt ƒë·∫ßu l·∫•y d·ªØ li·ªáu doanh thu...");

    const revenueReport = await Order.aggregate([
      {
        $group: {
          _id: { $dateToString: { format: "%Y-%m-%d", date: "$createdAt" } },
          totalRevenue: { $sum: "$totalPrice" },
          totalOrders: { $sum: 1 },
        },
      },
      { $sort: { _id: -1 } },
    ]);

    console.log("üìä D·ªØ li·ªáu doanh thu:", revenueReport);

    // Th√™m ki·ªÉm tra v√† x·ª≠ l√Ω khi kh√¥ng c√≥ d·ªØ li·ªáu
    if (revenueReport.length === 0) {
      return res.status(404).json({ message: "Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu" });
    }

    res.json(revenueReport);
  } catch (err) {
    console.error("‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu doanh thu:", err);
    res.status(500).json({ 
      error: "L·ªói server khi l·∫•y d·ªØ li·ªáu b√°o c√°o doanh thu",
      details: err.message 
    });
  }
});



// üìå API: L·∫•y d·ªØ li·ªáu c·∫£nh b√°o t·ªìn kho
app.get("/api/stock-warning", async (req, res) => {
  try {
    const lowStockItems = await Product.find({ $expr: { $lt: ["$quantity", "$minThreshold"] } });
    res.json(lowStockItems);
  } catch (error) {
    res.status(500).json({ error: "L·ªói khi l·∫•y d·ªØ li·ªáu c·∫£nh b√°o t·ªìn kho" });
  }
});

// üìå API: T√¨m ki·∫øm & l·ªçc s·∫£n ph·∫©m theo t√™n ho·∫∑c nh√† cung c·∫•p
app.get("/products/search", async (req, res) => {
  const { name } = req.query;
  const query = {};

  if (name && name.trim() !== "") {
    query.name = new RegExp(name, "i"); // Kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
  }

  try {
    const results = await Product.find(query);
    res.json(results);
  } catch (error) {
    res.status(500).json({ error: "L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m" });
  }
});

// --------------------- C√°c API Qu·∫£n l√Ω kho h√†ng -----------------------

// üìå API: Ki·ªÉm tra t·ªìn kho (l·∫•y danh s√°ch c√°c b·∫£n ghi trong Inventory)
app.get("/api/inventory", async (req, res) => {
  try {
    const inventoryList = await Inventory.find().populate("productId", "name");
    res.json(inventoryList);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// üìå API: Nh·∫≠p kho (ghi nh·∫≠n h√†ng nh·∫≠p v√†o kho)
app.post("/api/inventory/nhap", async (req, res) => {
  try {
    const { productId, quantity } = req.body;

    // T√¨m s·∫£n ph·∫©m trong kho
    let product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ error: "S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i" });
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
    product.quantity += quantity; // TƒÉng s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
    await product.save(); // L∆∞u thay ƒë·ªïi v√†o database

    res.json({ message: "Nh·∫≠p kho th√†nh c√¥ng", product });
  } catch (err) {
    console.error("Error during import:", err);
    res.status(500).json({ error: "L·ªói khi nh·∫≠p kho" });
  }
});

// üìå API: Xu·∫•t kho (ghi nh·∫≠n h√†ng xu·∫•t kho)
app.post("/api/inventory/xuat", async (req, res) => {
  try {
    const { productId, quantity } = req.body;

    // T√¨m s·∫£n ph·∫©m trong kho
    let product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ error: "S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i" });
    }

    // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho
    if (product.quantity < quantity) {
      return res.status(400).json({ error: "S·ªë l∆∞·ª£ng t·ªìn kho kh√¥ng ƒë·ªß" });
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
    product.quantity -= quantity;
    await product.save();

    // Ghi nh·∫≠n giao d·ªãch xu·∫•t kho
    const transaction = new Transaction({
      productId: product._id,
      type: "export",
      quantity,
      date: new Date(),
    });
    await transaction.save();

    res.json({ message: "Xu·∫•t kho th√†nh c√¥ng", product });
  } catch (err) {
    console.error("Error during export:", err);
    res.status(500).json({ error: "L·ªói khi xu·∫•t kho" });
  }
});

// üìå API: ƒêi·ªÅu ch·ªânh kho (c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th·ª±c t·∫ø khi ki·ªÉm k√™)
app.put("/api/inventory/dieuchinh", async (req, res) => {
  try {
    const { productId, newQuantity } = req.body;
    let record = await Inventory.findOne({ productId });
    if (!record) {
      record = new Inventory({ productId, quantity: newQuantity });
    } else {
      record.quantity = newQuantity;
    }
    record.lastUpdated = new Date();
    await record.save();
    res.json(record);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// --------------------- K·∫øt th√∫c API -----------------------

app.listen(PORT, () => console.log(`üöÄ Server running on port ${PORT}`));
